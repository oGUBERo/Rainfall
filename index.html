<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rainfall Data and Station Locations</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
        }
        h1, h2 {
            text-align: center;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }
        .left-column, .right-column {
            width: 100%;
        }
        #map {
            width: 100%;
            height: 400px;
            margin: 20px 0;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .search-controls {
            margin: 20px 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .search-controls select {
            width: 120px;
            margin-right: 10px;
        }
        #days-input {
            width: 100px;
            margin-right: 10px;
        }
        button {
            padding: 5px 10px;
        }
        #instructions {
            text-align: center;
            margin-bottom: 10px;
            font-style: italic;
        }
        #rainfall-container {
            margin-bottom: 20px;
        }
        #toggleTableBtn {
            display: block;
            margin: 20px auto;
        }
        
        @media screen and (min-width: 768px) {
            .left-column {
                width: 60%;
            }
            .right-column {
                width: 38%;
            }
        }
        .slider-container {
        display: flex;
        align-items: center;
        margin-top: 20px;
    }

    #days-slider {
        flex-grow: 1;
        margin-right: 10px;
    }

    #days-value {
        font-weight: bold;
        margin-right: 5px;
    }

    #update-button {
        margin-left: 10px;
    }
    #map-container {
        position: relative;
        width: 100%;
        height: 400px;
        margin: 20px 0;
    }

    #map {
        width: 100%;
        height: 100%;
    }

    #map-loading {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2em;
        z-index: 1000;
    }
</style>
</head>
<body>
    <h1>Rainfall Data and Station Locations</h1>
    <div class="container">
        <div class="left-column">
            <h2>Rainfall Data</h2>
            <div id="rainfall-container"></div>
            <canvas id="rainfallChart"></canvas>
            <div class="slider-container">
                <input type="range" id="days-slider" min="1" max="30" value="30" step="1">
                <span id="days-value">30</span> days
                <!-- Removed the update button -->
            </div>
        </div>
        <div class="right-column">
            <h2>Rainfall Station Locations</h2>
            <div class="search-controls">
                <div>
                    <label for="distance">Distance (km):</label>
                    <select id="distance">
                        <option value="10" selected>10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <button id="nearMeBtn">Locations near me</button>
            </div>

            <p id="instructions">Click on the map to set a custom search location</p>
            <div id="map-container">
                <div id="map"></div>
                <div id="map-loading">Loading map...</div>
            </div>
        </div>
    </div>

    <script>
        // Rainfall data script
        const rainfallContainer = document.getElementById('rainfall-container');
        const ctx = document.getElementById('rainfallChart').getContext('2d');
        let chart;

        async function fetchRainfallData(days) {
            const response = await fetch(`https://environment.data.gov.uk/flood-monitoring/id/stations/E7050/readings?_sorted&_limit=${days * 96}&parameter=rainfall`);
            const data = await response.json();
            return data.items;
        }

        function processRainfallData(data) {
            const dailyRainfall = {};
            data.forEach(item => {
                const date = new Date(item.dateTime).toLocaleDateString();
                const value = parseFloat(item.value);
                if (!dailyRainfall[date]) {
                    dailyRainfall[date] = 0;
                }
                dailyRainfall[date] += value;
            });
            return Object.entries(dailyRainfall).map(([date, value]) => ({ date, value: value.toFixed(2) }));
        }

        async function fetchStationData(stationReference, days) {
            const response = await fetch(`https://environment.data.gov.uk/flood-monitoring/id/stations/${stationReference}/readings?_sorted&_limit=${days * 96}&parameter=rainfall`);
            const data = await response.json();
            return data.items;
        }

        function processStationData(data) {
            const dailyRainfall = {};
            data.forEach(item => {
                const date = new Date(item.dateTime).toLocaleDateString();
                const value = parseFloat(item.value);
                if (!dailyRainfall[date]) {
                    dailyRainfall[date] = 0;
                }
                dailyRainfall[date] += value;
            });
            return Object.entries(dailyRainfall).map(([date, value]) => ({ date, value: value.toFixed(2) }));
        }

        async function updateStationChart(stationReference) {
            const days = parseInt(daysSlider.value);
            const rawData = await fetchStationData(stationReference, days);
            const processedData = processStationData(rawData);
            createChart(processedData, `Rainfall at Station ${stationReference}`);

            const totalRainfall = processedData.reduce((sum, item) => sum + parseFloat(item.value), 0).toFixed(2);
            rainfallContainer.innerHTML = `<p>Total rainfall at Station ${stationReference} for the last ${days} days: ${totalRainfall} mm</p>`;
        }
        function createChart(data, label = 'Daily Rainfall (mm)') {
            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(item => item.date),
                    datasets: [{
                        label: label,
                        data: data.map(item => item.value),
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Rainfall (mm)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    }
                }
            });
        }
        const daysSlider = document.getElementById('days-slider');
    const daysValue = document.getElementById('days-value');
    daysSlider.addEventListener('input', function() {
        daysValue.textContent = this.value;
        updateRainfallData(); // Add this line to update data when slider changes
    });

    async function updateRainfallData() {
        const days = parseInt(daysSlider.value);
        const defaultStationId = 'E7050';
        const rawData = await fetchRainfallData(days);
        const processedData = processRainfallData(rawData);
        createChart(processedData, `Rainfall at Station ${defaultStationId}`);

        const totalRainfall = processedData.reduce((sum, item) => sum + parseFloat(item.value), 0).toFixed(2);
        rainfallContainer.innerHTML = `<p>Total rainfall at Station ${defaultStationId} for the last ${days} days: ${totalRainfall} mm</p>`;
    }

    // Initial data fetch
    updateRainfallData();
        // Map script
        const map = L.map('map');
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        let markers = [];
        let userLocation;
        let searchLocation;

        // Create custom icons
        const blueIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        const redIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        const greenIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        function fetchStations(lat, long) {
            const dist = document.getElementById('distance').value;

            // Clear existing markers and table rows
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            //document.querySelector('#stationTable tbody').innerHTML = '';

            // Fetch data from the API with user-defined parameters
            fetch(`https://environment.data.gov.uk/flood-monitoring/id/stations?parameter=rainfall&lat=${lat}&long=${long}&dist=${dist}`)
                .then(response => response.json())
                .then(data => {
                    const stations = data.items;

                    stations.forEach(station => {
                        // Add marker to the map
                        const marker = L.marker([station.lat, station.long], {icon: redIcon})
                            .addTo(map)
                            .bindPopup(station.label + ' (' + station.stationReference + ')');
                        
                        // Add click event to the marker
                        marker.on('click', function() {
                            updateStationChart(station.stationReference);
                        });
                        
                        markers.push(marker);


                    });

                    // Center the map on the search location
                    map.setView([lat, long], 10);
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        function initializeMap() {
        const defaultLat = 50.691845;
        const defaultLong = -1.308358;

            // Set initial view
            map.setView([defaultLat, defaultLong], 10);

        // Add a marker for the default location
        searchLocation = L.marker([defaultLat, defaultLong], {icon: greenIcon}).addTo(map).bindPopup('Default Search Location');

        // Hide loading screen when map is ready
        document.getElementById('map-loading').style.display = 'none';

        // Add click event to the map
        map.on('click', function(e) {
                
                const clickedLat = e.latlng.lat;
                const clickedLng = e.latlng.lng;
                
                // Move the search location marker
                searchLocation.setLatLng([clickedLat, clickedLng]);
                
                // Update the search location popup
                searchLocation.setPopupContent(`Search Location<br>Lat: ${clickedLat.toFixed(4)}, Lng: ${clickedLng.toFixed(4)}`);
                searchLocation.openPopup();

                // Trigger search with new location
                fetchStations(clickedLat, clickedLng);

            });

            // Initial fetch
            fetchStations(defaultLat, defaultLong);
        }

        function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(updateMapToUserLocation, showError);
        } else {
            alert("Geolocation is not supported by this browser.");
        }
    }

    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(updateMapToUserLocation, showError);
        } else {
            alert("Geolocation is not supported by this browser.");
        }
    }

    function updateMapToUserLocation(position) {
        const lat = position.coords.latitude;
        const long = position.coords.longitude;

        // Update map view
        map.setView([lat, long], 10);

        // Update search location marker
        searchLocation.setLatLng([lat, long]);
        searchLocation.setPopupContent('Your Location');
        searchLocation.openPopup();
           // Add or update user location marker
        if (userLocation) {
            userLocation.setLatLng([lat, long]);
        } else {
            userLocation = L.marker([lat, long], {icon: blueIcon}).addTo(map).bindPopup('Your Location');
        }

        // Fetch stations for the new location
        fetchStations(lat, long);
    }

        function showError(error) {
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    alert("User denied the request for Geolocation.");
                    break;
                case error.POSITION_UNAVAILABLE:
                    alert("Location information is unavailable.");
                    break;
                case error.TIMEOUT:
                    alert("The request to get user location timed out.");
                    break;
                case error.UNKNOWN_ERROR:
                    alert("An unknown error occurred.");
                    break;
            }
        }

        function toggleTableVisibility() {
            const tableContainer = document.getElementById('stationTableContainer');
            if (tableContainer.style.display === 'none') {
                tableContainer.style.display = 'block';
            } else {
                tableContainer.style.display = 'none';
            }
        }

        document.getElementById('distance').addEventListener('change', function() {
            const latlng = searchLocation.getLatLng();
            fetchStations(latlng.lat, latlng.lng);
        });

        document.getElementById('nearMeBtn').addEventListener('click', getLocation);
        document.getElementById('map-loading').style.display = 'flex';
        // Initialize the map
        initializeMap();
    </script>
</body>
</html>