<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rainfall Station Locations</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
        }
        h1 {
            text-align: center;
        }
        #map {
            width: 100%;
            height: 400px;
            margin: 20px auto;
            max-width: 800px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .search-controls {
            max-width: 800px;
            margin: 20px auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .search-controls input {
            width: 100px;
            margin-right: 10px;
        }
        .search-controls button {
            padding: 5px 10px;
        }
        #instructions {
            text-align: center;
            margin-bottom: 10px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <h1>Rainfall Station Locations</h1>
    
    <div class="search-controls">
        <div>
            <label for="distance">Distance (km):</label>
            <input type="number" id="distance" step="1" value="10">
        </div>
        <button id="searchBtn">Search</button>
    </div>
    
    <p id="instructions">Shift+Click on the map to set a custom search location</p>
    
    <div id="map"></div>
    
    <table id="stationTable">
        <thead>
            <tr>
                <th>Station Reference</th>
                <th>Latitude</th>
                <th>Longitude</th>
                <th>Grid Reference</th>
                <th>Label</th>
            </tr>
        </thead>
        <tbody>
            <!-- Table content will be dynamically populated -->
        </tbody>
    </table>

    <script>
        const map = L.map('map');
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        let markers = [];
        let userLocation;
        let searchLocation;

        // Create custom icons
        const blueIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        const redIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        const greenIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        function fetchStations(lat, long) {
            const dist = document.getElementById('distance').value;

            // Clear existing markers and table rows
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            document.querySelector('#stationTable tbody').innerHTML = '';

            // Fetch data from the API with user-defined parameters
            fetch(`https://environment.data.gov.uk/flood-monitoring/id/stations?parameter=rainfall&lat=${lat}&long=${long}&dist=${dist}`)
                .then(response => response.json())
                .then(data => {
                    const stations = data.items;
                    const tableBody = document.querySelector('#stationTable tbody');

                    stations.forEach(station => {
                        // Add marker to the map
                        const marker = L.marker([station.lat, station.long], {icon: redIcon})
                            .addTo(map)
                            .bindPopup(station.label + ' (' + station.stationReference + ')');
                        markers.push(marker);

                        // Add row to the table
                        const row = tableBody.insertRow();
                        row.insertCell(0).textContent = station.stationReference;
                        row.insertCell(1).textContent = station.lat;
                        row.insertCell(2).textContent = station.long;
                        row.insertCell(3).textContent = station.gridReference;
                        row.insertCell(4).textContent = station.label;
                    });

                    // Center the map on the search location
                    map.setView([lat, long], 10);
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        function initializeMap(position) {
            const lat = position.coords.latitude;
            const long = position.coords.longitude;

            // Set initial view
            map.setView([lat, long], 10);

            // Add a marker for the user's location
            userLocation = L.marker([lat, long], {icon: blueIcon}).addTo(map).bindPopup('Your Location').openPopup();

            // Set initial search location
            searchLocation = L.marker([lat, long], {icon: greenIcon}).addTo(map).bindPopup('Search Location');

            // Add click event to the map
            map.on('click', function(e) {
                if (e.originalEvent.shiftKey) {
                    const clickedLat = e.latlng.lat;
                    const clickedLng = e.latlng.lng;
                    
                    // Move the search location marker
                    searchLocation.setLatLng([clickedLat, clickedLng]);
                    
                    // Update the search location popup
                    searchLocation.setPopupContent(`Search Location<br>Lat: ${clickedLat.toFixed(4)}, Lng: ${clickedLng.toFixed(4)}`);
                    searchLocation.openPopup();
                }
            });

            // Initial fetch
            fetchStations(lat, long);
        }

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(initializeMap, showError);
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        function showError(error) {
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    alert("User denied the request for Geolocation.");
                    break;
                case error.POSITION_UNAVAILABLE:
                    alert("Location information is unavailable.");
                    break;
                case error.TIMEOUT:
                    alert("The request to get user location timed out.");
                    break;
                case error.UNKNOWN_ERROR:
                    alert("An unknown error occurred.");
                    break;
            }
        }

        document.getElementById('searchBtn').addEventListener('click', function() {
            const latlng = searchLocation.getLatLng();
            fetchStations(latlng.lat, latlng.lng);
        });

        // Initialize the map
        getLocation();
    </script>
</body>
</html>